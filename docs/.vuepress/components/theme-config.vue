<template>
  <div class="config-wrap">
    <div v-for="(item, index) of list" :key="index" class="config-item">
      <div class="config-name">{{item.name}}：</div>
      <div class="config-input">
        <input placeholder="请输入" v-model="item.value" class="input-inner"
        :data-name="item.name"
         @change="e=>onChangeTheme(e, item)"
        />
      </div>
    </div>

    <div class="config-item">
      <div style="position: relative;">
      <div class="config-tooltip" v-if="copied">✨ 复制已变更条目成功</div>
      <button class="config-button config-button--primary" @click.stop="onCopy">一键复制</button>
      </div>
      <div style="margin-left: 16px;position: relative;">
      <div class="config-tooltip" v-if="resumed">还原成功</div>
      <button class="config-button config-button--default" @click.stop="onResume">还原</button>
      </div>
    </div>
  </div>
</template>
<script>
import themeDefaultJson from './theme-default.json'
const CHANGE_IFRAME_STYLE_TYPE = 'CHANGE_IFRAME_STYLE_TYPE';

function copyText(text) {
  var textareaC = document.createElement('textarea');
    textareaC.setAttribute('readonly', 'readonly'); //设置只读属性防止手机上弹出软键盘
    textareaC.value = text;
    document.body.appendChild(textareaC); //将textarea添加为body子元素
    textareaC.select();
    var res = document.execCommand('copy');
    document.body.removeChild(textareaC);//移除DOM元素
    return res;
}

function getComponentTheme(type) {
  if (!type) return [];

  const res = Object.keys(themeDefaultJson)
    .filter(key => {
      return key.startsWith(`$${type}`)
    })
    .map(key => ({ 
      name: key.replace(`$`, '--'),
      value: themeDefaultJson[key]
    }))
  return res;
}

export default {
  props: {
  },
  data() {
    return {
      copied: false,
      resumed: false,
      list: [],
      url: '',
      type: '',
    }
  },
  watch: {
    $page: {
			handler(newName) {
				const { frontmatter } = newName;
				this.url = frontmatter.url ? frontmatter.url : '';
        if (this.url) {
          const list = this.url.split('/')
          const newType = list[list.length - 1];
          console.log('newType', newType)
          if (newType !== this.type) {
            this.type = newType;
            this.list = getComponentTheme(newType);
          }
        }
        
			},
			immediate: true
		}
  },
  computed: {
  },
  mounted() {
    this.list = getComponentTheme(this.type);
  },
  methods: {
    onCopy() {
      this.copied = true;
      setTimeout(() => {
        this.copied = false;
      }, 2000)
      const diff = this.getChangedStyle().map(item => `${item.name}: ${item.newValue};`)

      copyText(diff.join('\n'))
    },
    onChangeTheme(e, item) {
      this.changeIframe({
        name: item.name,
        value: e.target.value
      })
    },
    changeIframe(style) {
      const iframe = document.getElementsByTagName('iframe')[0];
      iframe.contentWindow.postMessage({ type: CHANGE_IFRAME_STYLE_TYPE, data: style }, '*');
    },
    getChangedStyle() {
      const copyList = getComponentTheme(this.type);
      const obj = this.list.reduce((acc,item) => {
        acc[item.name] = item.value;
        return acc;
      }, {});
      
      const diff = []

      copyList.forEach(item => {
        if (item.value !== obj[item.name]) {
          diff.push({
            name: item.name,
            oldValue: item.value,
            newValue: obj[item.name]
          })
        }
      })
      return diff;
    },
    onResume() {
      const diff = this.getChangedStyle();

      const list = getComponentTheme(this.type);
      this.list = JSON.parse(JSON.stringify(list))

      diff.map(item => {
        this.changeIframe({
          name: item.name,
          value: item.oldValue,
        })
      })

      this.resumed = true;
      setTimeout(() => {
        this.resumed = false;
      }, 2000)
    },
  }
}
</script>
<style scoped >
.config-wrap {
  min-height: 50px;
  padding: 20px 0;
}

.config-item {
  display: flex;
  margin-bottom: 15px;
  position: relative;
}

.config-name {
  height: 40px;
  /* line-height: 40px; */
  display: flex;
  align-items: center;
  width: 310px;
  color: rgba(0, 0, 0, 0.8);
  font-size: 15px;
}

.config-input {
  width: 320px;
  position: relative;
  font-size: 14px;
  display: inline-block;

  margin-right: 15px;
  flex: 1;
}

.input-inner {
  -webkit-appearance: none;
  background-color: #fff;
  background-image: none;
  border-radius: 4px;
  border: 1px solid #dcdfe6;
  box-sizing: border-box;
  color: #606266;
  display: inline-block;
  font-size: inherit;
  height: 40px;
  line-height: 40px;
  outline: none;
  padding: 0 15px;
  transition: border-color 0.2s cubic-bezier(0.645, 0.045, 0.355, 1);
  width: 100%;
}

.config-button {
  display: inline-block;
  line-height: 1;
  white-space: nowrap;
  cursor: pointer;
  background: #fff;
  border: 1px solid #dcdfe6;
  color: #606266;
  -webkit-appearance: none;
  text-align: center;
  box-sizing: border-box;
  outline: none;
  margin: 0;
  transition: 0.1s;
  font-weight: 500;
  user-select: none;
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
  padding: 12px 20px;
  font-size: 14px;
  border-radius: 4px;

  margin-top: 20px;
}

.config-button--primary {
  color: #fff;
  background-color: #409eff;
  border-color: #409eff;
}

.config-button--primary:active {
  background: #3a8ee6;
  border-color: #3a8ee6;
  color: #fff;
}

.config-tooltip {
  animation: code-copy-animation 0.2s ease-out;
  animation-fill-mode: forwards;
  position: absolute;
  left: 5px;
  top: 0;
  z-index: 9;
  white-space: nowrap;
}

@keyframes code-copy-animation {
  0% {
    opacity: 0;
    top: 0;
  }

  to {
    opacity: 1;
    top: -10px;
  }
}
</style>